<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
   
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/styles.css" />
    <title>Dashboard ‚Äî Finance Tracker</title>
    
    <style>
      
      :root {
        --bg-body: #0f172a;      
        --bg-card: #1e293b;       
        --bg-input: #334155;      
        --text-main: #f1f5f9;    
        --text-muted: #94a3b8;   
        --primary: #3b82f6;      
        --success: #10b981;       
        --danger: #ef4444;        
        --warning: #f59e0b;      
        --border: #334155;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        min-height: 100vh;
      }

      /* --- LAYOUT --- */
      .page-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      /* --- ALERTS & USER BAR --- */
      .alert-box {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        color: var(--success);
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        animation: slideDown 0.4s ease;
      }

      .user-bar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }

      .user-email { color: var(--text-muted); font-size: 0.9rem; }
      
      .btn-logout {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-muted);
        padding: 6px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: 0.2s;
      }
      .btn-logout:hover { border-color: var(--danger); color: var(--danger); }

      /* --- STATS GRID --- */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: var(--bg-card);
        padding: 24px;
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }

      .stat-label { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
      .stat-value { font-size: 1.8rem; font-weight: 700; }
      .text-green { color: var(--success); }
      .text-red { color: var(--danger); }

      /* --- MAIN CONTENT GRID (Form + List) --- */
      .content-grid {
        display: grid;
        grid-template-columns: 350px 1fr; /* Fixed form, fluid list */
        gap: 24px;
        align-items: start;
      }

      @media (max-width: 850px) {
        .content-grid { grid-template-columns: 1fr; }
      }

   
      .card {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .card-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
      }
      .card-header h2 { font-size: 1.1rem; font-weight: 600; }
      .card-body { padding: 20px; }

  
      .form-group { margin-bottom: 16px; }
      label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
      
      input, select {
        width: 100%;
        padding: 10px 12px;
        background: var(--bg-input);
        border: 1px solid transparent;
        border-radius: 8px;
        color: var(--text-main);
        font-size: 0.95rem;
        outline: none;
        transition: 0.2s;
      }
      input:focus, select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }

      .btn {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
      }
      .btn-primary { background: var(--primary); color: white; }
      .btn-primary:hover { background: #2563eb; }
      
      .btn-secondary { background: var(--bg-input); color: var(--text-main); margin-top: 10px; }
      .btn-secondary:hover { background: #475569; }

      .form-actions { display: flex; gap: 10px; }

      /* --- TRANSACTION LIST --- */
      .transaction-list { list-style: none; max-height: 600px; overflow-y: auto; }
      
      .transaction-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        transition: background 0.2s;
      }
      .transaction-item:hover { background: rgba(255,255,255,0.02); }
      .transaction-item:last-child { border-bottom: none; }

      .tx-left { display: flex; align-items: center; gap: 12px; }
      
      .tx-icon {
        width: 36px; height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.05);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.1rem;
      }

      .tx-details h4 { font-size: 0.95rem; color: var(--text-main); font-weight: 500; }
      .tx-details span { font-size: 0.8rem; color: var(--text-muted); }

      .tx-right { text-align: right; }
      .tx-amount { font-weight: 700; font-size: 1rem; display: block; }
      
      .action-btns { display: flex; gap: 8px; margin-top: 4px; opacity: 0; transition: opacity 0.2s; }
      .transaction-item:hover .action-btns { opacity: 1; }
      
      .btn-icon {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        padding: 4px;
        border-radius: 4px;
      }
      .btn-edit { color: var(--warning); }
      .btn-edit:hover { background: rgba(245, 158, 11, 0.1); }
      .btn-delete { color: var(--danger); }
      .btn-delete:hover { background: rgba(239, 68, 68, 0.1); }

      /* Loading State */
      .loading { text-align: center; padding: 40px; color: var(--text-muted); }

      @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
  </head>
  <body>
    <div id="topbar"></div>
    
    <main class="page-container">
      
      <!-- Success Message -->
      <div id="successMessage" style="display:none;" class="alert-box">
        ‚úÖ Login successful! Welcome to your dashboard.
      </div>

      <!-- User Bar -->
      <div id="userInfo" class="user-bar" style="display:none;">
        <span class="user-email" id="userEmail"></span>
        <button id="logoutBtn" class="btn-logout">Sign Out</button>
      </div>

      <div id="app-container">
        
        <!-- Stats Row -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Income</div>
            <div class="stat-value text-green" id="display-income">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Expense</div>
            <div class="stat-value text-red" id="display-expense">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Profit</div>
            <div class="stat-value" id="profit-amount">$0.00</div>
          </div>
        </div>

        <div class="content-grid">
          
          <!-- Form Section -->
          <div class="card">
            <div class="card-header">
              <h2 id="form-title">Add Transaction</h2>
            </div>
            <div class="card-body">
              <form id="transaction-form">
                <div class="form-group">
                  <label>Type</label>
                  <select id="type" required>
                    <option value="income">üí∏ Income</option>
                    <option value="expense">üí≥ Expense</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Amount</label>
                  <input type="number" id="amount" placeholder="0.00" required step="0.01" />
                </div>
                <div class="form-group">
                  <label>Description</label>
                  <input type="text" id="description" placeholder="e.g. Grocery Shopping" required />
                </div>
                <div class="form-actions">
                  <button type="submit" id="submit-btn" class="btn btn-primary">Add Transaction</button>
                  <button type="button" id="cancel-btn" class="btn btn-secondary" style="display:none;">Cancel</button>
                </div>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2>Recent Transactions</h2>
            </div>
            <ul id="transaction-list" class="transaction-list">
              <li class="loading">Loading transactions...</li>
            </ul>
          </div>

        </div>
      </div>
    </main>

    <script src="/js/header.js"></script>
    <script>
     
      let transactions = [];
      let editingId = null;

    
      const els = {
        list: document.getElementById('transaction-list'),
        form: document.getElementById('transaction-form'),
        type: document.getElementById('type'),
        amount: document.getElementById('amount'),
        description: document.getElementById('description'),
        submitBtn: document.getElementById('submit-btn'),
        cancelBtn: document.getElementById('cancel-btn'),
        formTitle: document.getElementById('form-title'),
        displayIncome: document.getElementById('display-income'),
        displayExpense: document.getElementById('display-expense'),
        profitAmount: document.getElementById('profit-amount')
      };

     
      async function fetchTransactions() {
        try {
          const token = localStorage.getItem('token');
          const res = await fetch("http://localhost:3001/expenses", {
            headers: token ? { Authorization: `Bearer ${token}` } : {},
          });
          
          if (!res.ok) {
            if(res.status === 401 || res.status === 403) {
              
              window.location.href = '/src/pages/index.html';
            }
            throw new Error("Failed to fetch");
          }
          
          const data = await res.json();
          transactions = data;
          render();
        } catch (err) {
          console.error("Error fetching transactions:", err);
          els.list.innerHTML = `<li class="loading" style="color:var(--danger)">Failed to load data.</li>`;
        }
      }

    
      function render() {
        renderSummary();
        renderList();
      }

      function renderSummary() {
        const totalIncome = transactions
          .filter((t) => t.type === "income")
          .reduce((sum, t) => sum + t.amount, 0);
        
        const totalExpense = transactions
          .filter((t) => t.type === "expense")
          .reduce((sum, t) => sum + t.amount, 0);
        
        const profit = totalIncome - totalExpense;

        els.displayIncome.textContent = `$${totalIncome.toFixed(2)}`;
        els.displayExpense.textContent = `$${totalExpense.toFixed(2)}`;
        els.profitAmount.textContent = `$${profit.toFixed(2)}`;

        
        els.profitAmount.className = `stat-value ${profit >= 0 ? "text-green" : "text-red"}`;
      }

      function renderList() {
        els.list.innerHTML = ""; 

        if (transactions.length === 0) {
          els.list.innerHTML = "<li class='loading'>No transactions found. Add one to get started!</li>";
          return;
        }

        
        const sortedTx = [...transactions].sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));

        sortedTx.forEach((t) => {
          const li = document.createElement("li");
          li.className = `transaction-item`;
          
          const icon = t.type === "income" ? "üìà" : "üìâ";
          const amountClass = t.type === "income" ? "text-green" : "text-red";
          const sign = t.type === "income" ? "+" : "-";

          li.innerHTML = `
            <div class="tx-left">
              <div class="tx-icon">${icon}</div>
              <div class="tx-details">
                <h4>${t.description}</h4>
                <span>${new Date(t.date || t.createdAt).toLocaleDateString()}</span>
              </div>
            </div>
            <div class="tx-right">
              <span class="tx-amount ${amountClass}">${sign}$${Math.abs(t.amount).toFixed(2)}</span>
              <div class="action-btns">
                <button type="button" class="btn-icon btn-edit" onclick="handleEdit('${t._id}')" title="Edit">‚úèÔ∏è</button>
                <button type="button" class="btn-icon btn-delete" onclick="handleDelete('${t._id}')" title="Delete">üóëÔ∏è</button>
              </div>
            </div>
          `;
          els.list.appendChild(li);
        });
      }

   
      els.form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = {
          type: els.type.value,
          amount: parseFloat(els.amount.value),
          description: els.description.value,
        };

        try {
          const token = localStorage.getItem('token');
          const headers = { 
            "Content-Type": "application/json",
            ...(token && { Authorization: `Bearer ${token}` })
          };

          let res;
          if (editingId) {
            res = await fetch(`http://localhost:3001/expenses/${editingId}`, {
              method: "PUT",
              headers,
              body: JSON.stringify(payload),
            });
          } else {
            res = await fetch("http://localhost:3001/expenses", {
              method: "POST",
              headers,
              body: JSON.stringify(payload),
            });
          }

          if (!res.ok) throw new Error("Operation failed");

          await fetchTransactions();
          resetForm();

        } catch (err) {
          console.error(err);
          alert("An error occurred. Please try again.");
        }
      });

      // --- Actions ---
      window.handleEdit = function(id) {
        const t = transactions.find(item => item._id === id);
        if (!t) return;

        els.type.value = t.type;
        els.amount.value = t.amount;
        els.description.value = t.description;
        
        editingId = id;
        
        els.formTitle.textContent = "Edit Transaction";
        els.submitBtn.textContent = "Update Transaction";
        els.cancelBtn.style.display = "inline-block";
      };

      window.handleDelete = async function(id) {
        if (!window.confirm("Are you sure you want to delete this transaction?")) return;

        try {
          const token = localStorage.getItem('token');
          const res = await fetch(`http://localhost:3001/expenses/${id}`, { 
            method: "DELETE",
            headers: token ? { Authorization: `Bearer ${token}` } : {}
          });
          
          if (!res.ok) throw new Error("Delete failed");
          await fetchTransactions(); 
        } catch (err) {
          console.error("Error deleting:", err);
          alert("Failed to delete transaction.");
        }
      };

      function resetForm() {
        els.amount.value = "";
        els.description.value = "";
        els.type.value = "income";
        editingId = null;

        els.formTitle.textContent = "Add Transaction";
        els.submitBtn.textContent = "Add Transaction";
        els.cancelBtn.style.display = "none";
      }

      els.cancelBtn.addEventListener("click", resetForm);

     
      function initUI() {
        const userStr = localStorage.getItem('user');
        const user = userStr ? JSON.parse(userStr) : null;
        
        if (user) {
          document.getElementById('userInfo').style.display = 'flex';
          document.getElementById('userEmail').textContent = user.email || 'User';
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('loginSuccess') === 'true') {
          document.getElementById('successMessage').style.display = 'block';
          setTimeout(() => {
            document.getElementById('successMessage').style.display = 'none';
            window.history.replaceState({}, document.title, '/src/pages/dashboard.html');
          }, 3000);
        }
        
        fetchTransactions();
      }

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/src/pages/index.html';
      });

      
      document.addEventListener('DOMContentLoaded', initUI);
    </script>
  </body>
</html>